<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Apps</title>
    <style>
        * { box-sizing: border-box; } 

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #e9ecef; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .kotak-utama { max-width: 600px; margin: 0 auto 30px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #333; margin-top: 0; font-size: 24px; }
        
        #areaLogin { 
            text-align: center; 
            padding: 30px; 
            position: fixed; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%); 
            width: 90%; 
            max-width: 450px; 
            margin: 0; 
            z-index: 1000;
        }

        #areaApp { display: none; } 
        
        .btn-google { 
            background: #db4437; 
            color: white; 
            border: none; 
            padding: 12px 35px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px;
            margin-bottom: 10px; 
            transition: 0.3s; 
        }
        .btn-google:hover { background: #c53929; box-shadow: 0 4px 8px rgba(219,68,55,0.3); transform: translateY(-2px); }
        
        .nav-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f1f3f5; padding-bottom: 15px; align-items: center; justify-content: space-between; }
        .grup-tab { display: flex; gap: 10px; }
        .btn-tab { background: #f8f9fa; color: #495057; border: 1px solid #ced4da; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-tab.aktif { background: #4dabf7; color: white; border-color: #4dabf7; }
        .btn-logout { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        
        .info-user { margin-bottom: 15px; font-weight: bold; color: #495057; text-align: center; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; outline: none; font-size: 15px; transition: 0.3s; }
        input:focus { border-color: #4dabf7; box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.2); }
        
        button { cursor: pointer; transition: 0.3s; }
        .btn-simpan { background: #4dabf7; color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: bold; flex-shrink: 0; }
        .btn-simpan:hover { background: #3bc9db; }
        
        ul { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; align-items: start; }
        li { background: white; padding: 20px; border-radius: 12px; border-top: 5px solid #4dabf7; box-shadow: 0 4px 6px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: space-between; gap: 10px; transition: all 0.2s ease-in-out; }
        li:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        
        .waktu-teks { font-size: 11px; color: #adb5bd; border-bottom: 1px dashed #f1f3f5; padding-bottom: 8px; margin-bottom: 5px; }
        .isi-teks { width: 100%; word-break: break-word; white-space: pre-wrap; line-height: 1.6; color: #495057; font-size: 15px; }
        .grup-tombol { display: flex; gap: 8px; align-self: flex-end; border-top: 1px solid #f1f3f5; padding-top: 15px; margin-top: 5px; width: 100%; justify-content: flex-end; }
        .btn-aksi { padding: 6px 15px; font-size: 12px; border-radius: 6px; border: none; font-weight: bold; }
        .btn-edit { background: #fcc419; color: #333; }
        .btn-hapus { background: #ff6b6b; color: white; }
        
        .item-pengeluaran { border-top-color: #ff8787; } 
        .nominal-teks { font-size: 20px; font-weight: bold; color: #e03131; margin-top: 5px; }
        
        .area-ringkasan { display: flex; gap: 15px; margin-bottom: 20px; }
        .kotak-ringkasan { flex: 1; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid transparent; }
        .kotak-bulan { background: #e7f5ff; border-color: #74c0fc; color: #1864ab; }
        .kotak-hari { background: #fff5f5; border-color: #ff8787; color: #e03131; }
        
        .label-ringkasan { font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        .angka-ringkasan { font-size: 22px; font-weight: bold; }
        
        /* Grup Tanggal & Tombol Mode */
        .kontrol-tanggal { display: flex; gap: 10px; margin-bottom: 20px; }
        .pilih-tanggal { flex: 1; padding: 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 16px; text-align: center; color: #495057; font-weight: bold; cursor: pointer; background-color: #f8f9fa;}
        .pilih-tanggal:focus { border-color: #4dabf7; outline: none; background-color: white;}
        .btn-mode-waktu { padding: 0 20px; border-radius: 8px; border: 2px solid #4dabf7; background: white; color: #4dabf7; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-mode-waktu:hover { background: #e7f5ff; }
        .btn-mode-waktu.aktif { background: #4dabf7; color: white; }

        .input-cari { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; margin-bottom: 15px; outline: none; transition: 0.3s; background-color: #f8f9fa; }
        .input-cari:focus { border-color: #4dabf7; background-color: white; box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.2); }

        .bagian-aplikasi { display: none; }
        .bagian-aplikasi.aktif { display: block; }
        .pesan-kosong { text-align: center; color: #868e96; font-style: italic; width: 100%; grid-column: 1 / -1; margin-top: 20px; }

        @media (max-width: 500px) {
            body { padding: 10px; }
            .kotak-utama { padding: 20px; margin-bottom: 20px; }
            .input-group { flex-direction: column; }
            .btn-simpan { padding: 14px; }
            .nav-menu { flex-direction: column; gap: 15px; }
            .btn-logout { width: 100%; }
            .area-ringkasan { flex-direction: column; }
            .kontrol-tanggal { flex-direction: column; } /* Agar turun ke bawah di HP */
            .btn-mode-waktu { padding: 14px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="areaLogin" class="kotak-utama">
        <h2>Self Apps üîí</h2>
        <p style="color: #6c757d; margin-bottom: 20px;">Silakan masuk untuk melanjutkan.</p>
        <button id="btnLogin" class="btn-google">Masuk dengan Google</button>
    </div>

    <div id="areaApp">
        <div class="kotak-utama">
            <div id="infoUser" class="info-user"></div>
            
            <div class="nav-menu">
                <div class="grup-tab">
                    <button id="btnMenuCatatan" class="btn-tab aktif">üìù Catatan</button>
                    <button id="btnMenuPengeluaran" class="btn-tab">üí∞ Pengeluaran</button>
                </div>
                <button id="btnLogout" class="btn-logout">Keluar</button>
            </div>
            
            <div class="kontrol-tanggal">
                <input type="date" id="inputTanggalPilih" class="pilih-tanggal" title="Pilih hari untuk melihat jurnal">
                <button id="btnModeWaktu" class="btn-mode-waktu">Lihat Sebulan</button>
            </div>
            
            <div id="halamanCatatan" class="bagian-aplikasi aktif">
                <input type="text" id="inputCariCatatan" class="input-cari" placeholder="üîç Cari catatan lama atau kata kunci...">
                
                <div class="input-group">
                    <input type="text" id="inputCatatan" placeholder="Tulis Catatan...">
                    <button id="btnSimpanCatatan" class="btn-simpan">Simpan Catatan</button>
                </div>
            </div>

            <div id="halamanPengeluaran" class="bagian-aplikasi">
                <div class="area-ringkasan">
                    <div class="kotak-ringkasan kotak-hari">
                        <div class="label-ringkasan">Pengeluaran Hari Ini</div>
                        <div id="angkaTotalHari" class="angka-ringkasan">Rp 0</div>
                    </div>
                    <div class="kotak-ringkasan kotak-bulan">
                        <div class="label-ringkasan">Pengeluaran Bulan Ini</div>
                        <div id="angkaTotalBulan" class="angka-ringkasan">Rp 0</div>
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" id="inputNamaPengeluaran" placeholder="Nama Barang (Misal: Kopi)">
                    <input type="number" id="inputNominalPengeluaran" placeholder="Harga (Misal: 15000)">
                </div>
                <button id="btnSimpanPengeluaran" class="btn-simpan" style="width: 100%; padding: 14px; margin-bottom: 10px; background-color:#ff8787;">Catat Pengeluaran</button>
            </div>
        </div>

        <ul id="daftarItem"></ul>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsRTS_VwqllFKsMqzb_v7iwfH6DL7Lma0",
    authDomain: "catatanku-bfa2a.firebaseapp.com",
    projectId: "catatanku-bfa2a",
    storageBucket: "catatanku-bfa2a.firebasestorage.app",
    messagingSenderId: "661605719763",
    appId: "1:661605719763:web:0f1f1cac9c7f782ff83e26"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let modeAktif = "catatan"; 
  let modeTampilWaktu = "hari"; // State baru: "hari" atau "bulan"
  
  let dataCatatanPribadi = [];
  let dataPengeluaranPribadi = [];

  const inputTanggal = document.getElementById('inputTanggalPilih');
  const inputCari = document.getElementById('inputCariCatatan'); 
  const btnModeWaktu = document.getElementById('btnModeWaktu'); // Tombol baru

  const tzoffset = (new Date()).getTimezoneOffset() * 60000; 
  const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 10);
  inputTanggal.value = localISOTime;

  // Event Listener jika tanggal diubah -> kembalikan mode ke "Harian" otomatis
  inputTanggal.addEventListener('change', () => {
      modeTampilWaktu = "hari";
      btnModeWaktu.innerText = "Lihat Sebulan";
      btnModeWaktu.classList.remove("aktif");
      renderLayar();
  });
  
  inputCari.addEventListener('input', () => renderLayar());

  // Event Listener untuk Tombol Toggle Sebulan / Harian
  btnModeWaktu.addEventListener('click', () => {
      if (modeTampilWaktu === "hari") {
          modeTampilWaktu = "bulan";
          btnModeWaktu.innerText = "Lihat Harian";
          btnModeWaktu.classList.add("aktif");
      } else {
          modeTampilWaktu = "hari";
          btnModeWaktu.innerText = "Lihat Sebulan";
          btnModeWaktu.classList.remove("aktif");
      }
      renderLayar();
  });

  document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
  document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, (user) => {
      if (user) {
          currentUser = user;
          document.getElementById('areaLogin').style.display = 'none';
          document.getElementById('areaApp').style.display = 'block';
          document.getElementById('infoUser').innerText = `Halo, ${user.displayName}!`;
          
          onValue(ref(database, 'catatan_pribadi/' + user.uid), (snapshot) => {
              dataCatatanPribadi = [];
              snapshot.forEach(child => { dataCatatanPribadi.push({ id: child.key, ...child.val() }) });
              if(modeAktif === "catatan") renderLayar();
          });

          onValue(ref(database, 'pengeluaran_pribadi/' + user.uid), (snapshot) => {
              dataPengeluaranPribadi = [];
              snapshot.forEach(child => { dataPengeluaranPribadi.push({ id: child.key, ...child.val() }) });
              if(modeAktif === "pengeluaran") renderLayar();
          });

      } else {
          currentUser = null;
          document.getElementById('areaLogin').style.display = 'block';
          document.getElementById('areaApp').style.display = 'none';
      }
  });

  document.getElementById('btnMenuCatatan').addEventListener('click', () => gantiTab('catatan'));
  document.getElementById('btnMenuPengeluaran').addEventListener('click', () => gantiTab('pengeluaran'));

  function gantiTab(tab) {
      modeAktif = tab;
      document.getElementById('btnMenuCatatan').classList.toggle('aktif', tab === 'catatan');
      document.getElementById('btnMenuPengeluaran').classList.toggle('aktif', tab === 'pengeluaran');
      document.getElementById('halamanCatatan').classList.toggle('aktif', tab === 'catatan');
      document.getElementById('halamanPengeluaran').classList.toggle('aktif', tab === 'pengeluaran');
      
      if (inputCari) inputCari.value = ""; 
      renderLayar();
  }

  function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }
  function bersihkanTeks(teks) { const d = document.createElement('div'); d.innerText = teks; return d.innerHTML; }
  function formatWaktuDetail() { return new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }); }

  function renderLayar() {
      const daftar = document.getElementById('daftarItem');
      daftar.innerHTML = "";
      const tglPilih = inputTanggal.value; 
      const blnPilih = tglPilih.substring(0, 7); // Format: YYYY-MM

      if (modeAktif === "catatan") {
          let htmlCatatan = ""; 
          let jumlahTampil = 0;
          const kataKunci = inputCari ? inputCari.value.toLowerCase() : "";

          dataCatatanPribadi.forEach(data => {
              const teksAman = bersihkanTeks(data.isi);
              let tampilkan = false;

              if (kataKunci !== "") {
                  if (data.isi.toLowerCase().includes(kataKunci)) { tampilkan = true; }
              } else {
                  // Cek apakah mode bulan atau hari
                  if (modeTampilWaktu === "bulan") {
                      if (data.tanggal_db && data.tanggal_db.startsWith(blnPilih)) tampilkan = true;
                  } else {
                      if (data.tanggal_db === tglPilih) tampilkan = true;
                  }
              }

              if (tampilkan) {
                  jumlahTampil++;
                  // Info tanggal muncul jika mencari ATAU mode sebulan aktif
                  const infoTanggal = (kataKunci !== "" || modeTampilWaktu === "bulan") 
                      ? `<div class="waktu-teks" style="color:#4dabf7; font-weight:bold;">üìÖ Tanggal: ${data.tanggal_db}</div>` : "";
                  
                  htmlCatatan += `
                      <li>
                          ${infoTanggal}
                          <div class="waktu-teks">üïí Jam Input: ${data.jam_input || '-'}</div>
                          <span class="isi-teks">${teksAman}</span>
                          <div class="grup-tombol">
                              <button class="btn-aksi btn-edit" data-id="${data.id}" data-jenis="catatan">Edit</button>
                              <button class="btn-aksi btn-hapus" data-id="${data.id}" data-jenis="catatan">Hapus</button>
                          </div>
                      </li>`;
              }
          });

          if (jumlahTampil === 0) {
              if (kataKunci !== "") {
                  daftar.innerHTML = `<div class='pesan-kosong'>Tidak menemukan catatan dengan kata kunci "${kataKunci}".</div>`;
              } else if (modeTampilWaktu === "bulan") {
                  const namaBulan = new Date(tglPilih).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                  daftar.innerHTML = `<div class='pesan-kosong'>Tidak ada catatan di bulan ${namaBulan}.</div>`;
              } else {
                  daftar.innerHTML = `<div class='pesan-kosong'>Tidak ada catatan di tanggal ${tglPilih}.</div>`;
              }
          } else {
              daftar.innerHTML = htmlCatatan;
          }

      } else {
          let totalBulan = 0; let totalHari = 0;
          let htmlHariIni = ""; let jumlahTampilPengeluaran = 0;

          dataPengeluaranPribadi.forEach(data => {
              // Kalkulasi ringkasan selalu berjalan utuh
              if (data.tanggal_db && data.tanggal_db.startsWith(blnPilih)) totalBulan += data.harga;
              if (data.tanggal_db === tglPilih) totalHari += data.harga;

              // Penentuan item apa yang di list (Harian vs Bulanan)
              let tampilkan = false;
              if (modeTampilWaktu === "bulan") {
                  if (data.tanggal_db && data.tanggal_db.startsWith(blnPilih)) tampilkan = true;
              } else {
                  if (data.tanggal_db === tglPilih) tampilkan = true;
              }

              if (tampilkan) {
                  jumlahTampilPengeluaran++;
                  const infoTgl = modeTampilWaktu === "bulan" ? `<div class="waktu-teks" style="color:#e03131; font-weight:bold;">üìÖ Tanggal: ${data.tanggal_db}</div>` : "";
                  htmlHariIni += `
                      <li class="item-pengeluaran">
                          ${infoTgl}
                          <div class="waktu-teks">üïí Jam Input: ${data.jam_input || '-'}</div>
                          <span class="isi-teks">${bersihkanTeks(data.nama_item)}</span>
                          <div class="nominal-teks">${formatRupiah(data.harga)}</div>
                          <div class="grup-tombol">
                              <button class="btn-aksi btn-hapus" data-id="${data.id}" data-jenis="pengeluaran">Hapus</button>
                          </div>
                      </li>`;
              }
          });

          document.getElementById('angkaTotalBulan').innerText = formatRupiah(totalBulan);
          document.getElementById('angkaTotalHari').innerText = formatRupiah(totalHari);
          
          if (jumlahTampilPengeluaran === 0) {
               if (modeTampilWaktu === "bulan") {
                   const namaBulan = new Date(tglPilih).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                   daftar.innerHTML = `<div class='pesan-kosong'>Tidak ada pengeluaran di bulan ${namaBulan}.</div>`;
               } else {
                   daftar.innerHTML = `<div class='pesan-kosong'>Tidak ada pengeluaran di tanggal ${tglPilih}.</div>`;
               }
          } else daftar.innerHTML = htmlHariIni;
      }
  }

  document.getElementById('btnSimpanCatatan').addEventListener('click', () => {
      const teks = document.getElementById('inputCatatan').value;
      const tanggalDipilih = document.getElementById('inputTanggalPilih').value;
      if (teks && currentUser) {
          push(ref(database, 'catatan_pribadi/' + currentUser.uid), { 
              isi: teks, tanggal_db: tanggalDipilih, jam_input: formatWaktuDetail()
          });
          document.getElementById('inputCatatan').value = ""; 
          if (inputCari) inputCari.value = ""; 
      }
  });

  document.getElementById('btnSimpanPengeluaran').addEventListener('click', () => {
      const nama = document.getElementById('inputNamaPengeluaran').value;
      const nominal = document.getElementById('inputNominalPengeluaran').value;
      const tanggalDipilih = document.getElementById('inputTanggalPilih').value;
      if (nama && nominal && currentUser) {
          push(ref(database, 'pengeluaran_pribadi/' + currentUser.uid), { 
              nama_item: nama, harga: Number(nominal), tanggal_db: tanggalDipilih, jam_input: formatWaktuDetail()
          });
          document.getElementById('inputNamaPengeluaran').value = ""; 
          document.getElementById('inputNominalPengeluaran').value = ""; 
      }
  });

  document.getElementById('daftarItem').addEventListener('click', function(e) {
      const target = e.target;
      const idItem = target.getAttribute('data-id');
      const jenis = target.getAttribute('data-jenis'); 
      if(target.classList.contains('btn-hapus')) {
          const folder = jenis === 'catatan' ? 'catatan_pribadi/' : 'pengeluaran_pribadi/';
          remove(ref(database, folder + currentUser.uid + '/' + idItem));
      }
      if(target.classList.contains('btn-edit') && jenis === 'catatan') {
          const teksLama = target.closest('li').querySelector('.isi-teks').innerText;
          const teksBaru = prompt("Ubah catatan:", teksLama);
          if (teksBaru !== null && teksBaru.trim() !== "") {
              update(ref(database, `catatan_pribadi/${currentUser.uid}/${idItem}`), { 
                  isi: teksBaru, jam_input: formatWaktuDetail() + " (Diedit)" 
              });
          }
      }
  });
</script>

</body>
</html>
